---
phase: 01-documentation-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - inst/WORDLIST
  - R/residualize.R
  - R/hrf-formula.R
  - R/validate.R
  - R/contrast.R
  - R/design_generics.R
autonomous: true

must_haves:
  truths:
    - "spelling::spell_check_package() returns zero errors or all flagged words are in WORDLIST"
    - "All exported functions have @return documentation"
    - "All @examples run without error via devtools::run_examples()"
    - "\\dontrun{} used only where truly necessary (external package context)"
    - "urlchecker::url_check() returns no broken URLs"
    - "All exported functions have complete @param documentation"
  artifacts:
    - path: "inst/WORDLIST"
      provides: "Technical term whitelist for spell checker"
      contains: "HRF"
    - path: "R/residualize.R"
      provides: "S3 methods with @return and @examples"
      min_lines: 60
    - path: "R/validate.R"
      provides: "validate_contrasts and check_collinearity with runnable examples"
      contains: "fmrihrf::sampling_frame"
    - path: "R/hrf-formula.R"
      provides: "boxcar_hrf_gen and weighted_hrf_gen with runnable examples"
      contains: "fmrihrf::sampling_frame"
  key_links:
    - from: "inst/WORDLIST"
      to: "spelling::spell_check_package()"
      via: "Automatic recognition by spelling package"
    - from: "R/*.R"
      to: "man/*.Rd"
      via: "devtools::document() regenerates .Rd files"
---

<objective>
Fix all documentation quality issues for Phase 1 CRAN submission readiness.

Purpose: Ensure all exported functions have complete, error-free documentation that passes CRAN checks.
Output: Updated R source files with complete roxygen2 documentation, inst/WORDLIST for technical terms.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-documentation-quality/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create inst/WORDLIST for technical terms</name>
  <files>inst/WORDLIST</files>
  <action>
Create the inst/ directory if it doesn't exist and create inst/WORDLIST with the following technical terms (one per line, alphabetically sorted):

AFNI
Albers
albersdown
baselinespec
blockspec
bs
bspline
CFALS
cli
convolve
Convolve
convolved
Convolves
convolving
covariatespec
CSF
dmat
Estimability
fac
fmrihrf
fmrireg
ggplot
hemodynamic
Hemodynamic
hrf
HRF
HRFs
hrfspec
Ident
inspectable
ISI
longnames
multicollinearity
Multicollinearity
nA
nB
ns
nuisancespec
oneway
ParametricBasis
pearson
pkgdown
pre
Pre
queryable
Quickstart
realisation
recognised
Residualize
RobustScale
runwise
Sanitization
shortnames
spearman
SPM
spmg
SPMG
summarise
summate
th
tibble
tibbles
timecourse
timecourses
trialwise
Trialwise
TRs
upsampling

Run `Rscript -e "spelling::spell_check_package()"` to verify no remaining spelling issues (or only expected words).
  </action>
  <verify>Rscript -e "result <- spelling::spell_check_package(); if(nrow(result) > 0) { print(result); stop('Spelling errors remain') } else { cat('OK: No spelling errors\n') }"</verify>
  <done>spelling::spell_check_package() returns zero rows or only words that are intentionally not in WORDLIST</done>
</task>

<task type="auto">
  <name>Task 2: Add @return and @examples to residualize methods</name>
  <files>R/residualize.R</files>
  <action>
Update R/residualize.R to add proper @return documentation, @param documentation, and @examples to the residualize-methods documentation block.

The file currently has a minimal documentation stub at the top (lines 1-7) that only references the generic, followed by the S3 method implementations.

**Replace the documentation block** (the roxygen comment block ending with `NULL`) with a complete documentation block that includes:

1. A description explaining what these methods do (project data onto orthogonal complement of a design, returning OLS residuals)
2. @param documentation for all parameters: x, data, cols, ...
3. @return documentation specifying the output (numeric matrix of residuals with same dimensions as data)
4. @examples with two runnable examples:
   - One showing residualize with a raw matrix
   - One showing residualize with an event_model (requires creating a sampling_frame and event_model)

**Also add** `@rdname residualize-methods` to each S3 method export (after @export) to link them to the main documentation.

Example structure for the documentation block:
```r
#' Residualize methods
#'
#' S3 methods for the `residualize()` generic. These methods project data
#' onto the orthogonal complement of a design, returning OLS residuals.
#'
#' @param x A design object: matrix, event_model, or baseline_model.
#' @param data Numeric vector/matrix/data.frame of observations Y.
#' @param cols Optional integer or character vector selecting columns to project out.
#' @param ... Additional arguments (currently unused).
#'
#' @return A numeric matrix of residuals with the same dimensions as `data`.
#'
#' @examples
#' # Residualize with a raw matrix
#' X <- cbind(1, 1:10)
#' Y <- matrix(rnorm(20), ncol = 2)
#' R <- residualize(X, Y)
#' dim(R)  # 10 x 2
#'
#' # Residualize with an event model
#' des <- data.frame(
#'   onset = c(0, 10, 20, 30),
#'   run = 1,
#'   cond = factor(c("A", "B", "A", "B"))
#' )
#' sframe <- fmrihrf::sampling_frame(blocklens = 40, TR = 1)
#' emod <- event_model(onset ~ hrf(cond), data = des, block = ~run,
#'                     sampling_frame = sframe)
#' Y_sim <- matrix(rnorm(40 * 2), ncol = 2)
#' R_emod <- residualize(emod, Y_sim)
#' dim(R_emod)  # 40 x 2
#'
#' @name residualize-methods
#' @rdname residualize-methods
NULL
```
  </action>
  <verify>Rscript -e "devtools::document(); devtools::run_examples(run_donttest = FALSE)" 2>&1 | tail -20</verify>
  <done>residualize-methods.Rd has @return and @examples sections; examples run without error</done>
</task>

<task type="auto">
  <name>Task 3: Convert \dontrun{} to runnable examples</name>
  <files>R/validate.R, R/hrf-formula.R, R/contrast.R</files>
  <action>
Convert 4 \dontrun{} blocks to fully runnable examples by including necessary setup code.

**R/validate.R - validate_contrasts():**
Replace the \dontrun{} example with a runnable example that:
- Creates a data.frame with onset, run, cond columns
- Creates a sampling_frame using fmrihrf::sampling_frame()
- Creates an event_model
- Calls validate_contrasts() on it
- Shows how to validate a custom weight vector

**R/validate.R - check_collinearity():**
Replace the \dontrun{} example with a runnable example that:
- Creates an event_model (same pattern as above)
- Calls check_collinearity(design_matrix(emod), threshold = 0.95)
- Shows conditional printing of pairs if not ok

**R/hrf-formula.R - boxcar_hrf_gen():**
Replace the \dontrun{} example with a runnable example that:
- Creates trial_data with onset, duration, condition, run columns
- Creates a sampling_frame
- Creates an event_model using boxcar_hrf_gen() as the hrf_fun

**R/hrf-formula.R - weighted_hrf_gen():**
Replace the \dontrun{} example with a runnable example that:
- Creates trial_data with onset, sub_times (as list column), sub_weights (as list column), run
- Creates a sampling_frame
- Creates an event_model using weighted_hrf_gen()

**Keep \dontrun{} for:**
- R/extension_registry.R - register_hrfspec_extension() (legitimately requires external package context)
- R/contrast.R - translate_legacy_pattern() (internal function, illustrative only)

After making changes, run devtools::document() to regenerate .Rd files.
  </action>
  <verify>Rscript -e "devtools::document(); devtools::run_examples(run_donttest = FALSE)" 2>&1 | tail -30</verify>
  <done>Only register_hrfspec_extension() and translate_legacy_pattern() use \dontrun{}; all other examples run successfully</done>
</task>

<task type="auto">
  <name>Task 4: Add missing @param documentation to S3 methods</name>
  <files>R/design_generics.R, R/residualize.R</files>
  <action>
Add @param documentation for the `...` parameter to S3 methods that are missing it.

**S3 methods with ... parameter needing documentation:**

For each S3 method that has a `...` parameter but lacks documentation for it, add:
```r
#' @param ... Additional arguments (currently unused).
```

Check the following files for S3 methods with undocumented ... parameter:
- R/design_generics.R: Check all generics/methods
- R/residualize.R: The residualize.* methods (if not already covered in Task 2)

The research identified approximately 8 S3 methods with undocumented ... parameters. Most are pass-through arguments to other methods.

**Pattern for documenting ... in S3 methods:**
- If ... is passed to parent method: "@param ... Additional arguments passed to methods."
- If ... is unused: "@param ... Additional arguments (currently unused)."
- If ... has specific use: Document that specific use.

Ensure each method either has its own @param ... documentation OR is linked via @rdname to a documentation block that documents it.
  </action>
  <verify>Rscript -e "devtools::document(); tools::checkDocFiles(dir='.')" 2>&1 | grep -i "param\|missing" || echo "OK: No missing param warnings"</verify>
  <done>All exported S3 methods have @param documentation for ... parameter; no warnings about missing params</done>
</task>

<task type="auto">
  <name>Task 5: Verify URLs in documentation</name>
  <files>None (verification only)</files>
  <action>
Run urlchecker::url_check() to verify all URLs in the package documentation are valid and accessible.

Steps:
1. Run urlchecker::url_check() on the package
2. Review output for any broken or redirected URLs
3. If any URLs are broken:
   - For broken external links: Update to correct URL or remove if resource no longer exists
   - For redirected URLs: Update to canonical URL if redirect is permanent

Expected: The research indicates all URLs are currently valid, so this should pass. This task ensures the requirement is verified.
  </action>
  <verify>Rscript -e "result <- urlchecker::url_check(); if(any(result[['Status']] != 'OK' & !is.na(result[['Status']]))) { print(result); stop('URL issues found') } else { cat('OK: All URLs valid\n') }"</verify>
  <done>urlchecker::url_check() returns all OK status or no URLs to check</done>
</task>

</tasks>

<verification>
After all tasks complete, run the full verification suite:

```r
# 1. Regenerate documentation
devtools::document()

# 2. Check spelling
result <- spelling::spell_check_package()
stopifnot(nrow(result) == 0)

# 3. Check URLs
urlchecker::url_check()

# 4. Run all examples
devtools::run_examples(run_donttest = FALSE)

# 5. Check for missing documentation
tools::checkDocFiles(dir = ".")

# 6. Run package check (should show no new warnings related to documentation)
devtools::check(document = FALSE, args = c('--no-tests', '--no-vignettes'))
```

Expected outcomes:
- spelling::spell_check_package() returns 0 rows
- urlchecker::url_check() returns all OK
- devtools::run_examples() completes without errors
- tools::checkDocFiles() reports no missing documentation
- devtools::check() shows no documentation-related warnings
</verification>

<success_criteria>
1. inst/WORDLIST exists with ~70 technical terms
2. urlchecker::url_check() returns no broken URLs
3. spelling::spell_check_package() returns zero errors
4. Every exported function has complete @param documentation (no warnings)
5. residualize-methods.Rd has @return and @examples sections
6. validate_contrasts() example runs without error
7. check_collinearity() example runs without error
8. boxcar_hrf_gen() example runs without error
9. weighted_hrf_gen() example runs without error
10. Only 2 \dontrun{} remain (register_hrfspec_extension, translate_legacy_pattern)
11. devtools::run_examples() completes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-documentation-quality/01-01-SUMMARY.md`
</output>
