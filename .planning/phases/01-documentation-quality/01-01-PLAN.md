---
phase: 01-documentation-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - inst/WORDLIST
  - R/residualize.R
  - R/hrf-formula.R
  - R/validate.R
  - R/contrast.R
autonomous: true

must_haves:
  truths:
    - "spelling::spell_check_package() returns zero errors or all flagged words are in WORDLIST"
    - "All exported functions have @return documentation"
    - "All @examples run without error via devtools::run_examples()"
    - "\\dontrun{} used only where truly necessary (external package context)"
  artifacts:
    - path: "inst/WORDLIST"
      provides: "Technical term whitelist for spell checker"
      contains: "HRF"
    - path: "R/residualize.R"
      provides: "S3 methods with @return and @examples"
      min_lines: 60
    - path: "R/validate.R"
      provides: "validate_contrasts and check_collinearity with runnable examples"
      contains: "fmrihrf::sampling_frame"
    - path: "R/hrf-formula.R"
      provides: "boxcar_hrf_gen and weighted_hrf_gen with runnable examples"
      contains: "fmrihrf::sampling_frame"
  key_links:
    - from: "inst/WORDLIST"
      to: "spelling::spell_check_package()"
      via: "Automatic recognition by spelling package"
    - from: "R/*.R"
      to: "man/*.Rd"
      via: "devtools::document() regenerates .Rd files"
---

<objective>
Fix all documentation quality issues for Phase 1 CRAN submission readiness.

Purpose: Ensure all exported functions have complete, error-free documentation that passes CRAN checks.
Output: Updated R source files with complete roxygen2 documentation, inst/WORDLIST for technical terms.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-documentation-quality/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create inst/WORDLIST for technical terms</name>
  <files>inst/WORDLIST</files>
  <action>
Create the inst/ directory if it doesn't exist and create inst/WORDLIST with the following technical terms (one per line, alphabetically sorted):

AFNI
Albers
albersdown
baselinespec
blockspec
bs
bspline
CFALS
cli
convolve
Convolve
convolved
Convolves
convolving
covariatespec
CSF
dmat
Estimability
fac
fmrihrf
fmrireg
ggplot
hemodynamic
Hemodynamic
hrf
HRF
HRFs
hrfspec
Ident
inspectable
ISI
longnames
multicollinearity
Multicollinearity
nA
nB
ns
nuisancespec
oneway
ParametricBasis
pearson
pkgdown
pre
Pre
queryable
Quickstart
realisation
recognised
Residualize
RobustScale
runwise
Sanitization
shortnames
spearman
SPM
spmg
SPMG
summarise
summate
th
tibble
tibbles
timecourse
timecourses
trialwise
Trialwise
TRs
upsampling

Run `Rscript -e "spelling::spell_check_package()"` to verify no remaining spelling issues (or only expected words).
  </action>
  <verify>Rscript -e "result <- spelling::spell_check_package(); if(nrow(result) > 0) { print(result); stop('Spelling errors remain') } else { cat('OK: No spelling errors\n') }"</verify>
  <done>spelling::spell_check_package() returns zero rows or only words that are intentionally not in WORDLIST</done>
</task>

<task type="auto">
  <name>Task 2: Add @return and @examples to residualize methods</name>
  <files>R/residualize.R</files>
  <action>
Update R/residualize.R to add proper @return documentation and @examples to the residualize-methods documentation block.

The file currently has:
- Line 1-7: Documentation stub with @name residualize-methods and @keywords internal
- Lines 22-33: residualize.matrix method
- Lines 35-47: residualize.event_model method
- Lines 49-61: residualize.baseline_model method

Update the documentation block at lines 1-7 to:

```r
#' Residualize methods
#'
#' S3 methods for the `residualize()` generic. These methods project data
#' onto the orthogonal complement of a design, returning OLS residuals.
#'
#' @param x A design object: matrix, event_model, or baseline_model.
#' @param data Numeric vector/matrix/data.frame of observations Y.
#' @param cols Optional integer or character vector selecting columns to project out.
#' @param ... Additional arguments (currently unused).
#'
#' @return A numeric matrix of residuals with the same dimensions as `data`.
#'
#' @examples
#' # Residualize with a raw matrix
#' X <- cbind(1, 1:10)
#' Y <- matrix(rnorm(20), ncol = 2)
#' R <- residualize(X, Y)
#' dim(R)  # 10 x 2
#'
#' # Residualize with an event model
#' des <- data.frame(
#'   onset = c(0, 10, 20, 30),
#'   run = 1,
#'   cond = factor(c("A", "B", "A", "B"))
#' )
#' sframe <- fmrihrf::sampling_frame(blocklens = 40, TR = 1)
#' emod <- event_model(onset ~ hrf(cond), data = des, block = ~run,
#'                     sampling_frame = sframe)
#' Y_sim <- matrix(rnorm(40 * 2), ncol = 2)
#' R_emod <- residualize(emod, Y_sim)
#' dim(R_emod)  # 40 x 2
#'
#' @name residualize-methods
#' @rdname residualize-methods
NULL
```

Add @rdname residualize-methods to each S3 method (after @export).
  </action>
  <verify>Rscript -e "devtools::document(); devtools::run_examples(run_donttest = FALSE)" 2>&1 | tail -20</verify>
  <done>residualize-methods.Rd has @return and @examples sections; examples run without error</done>
</task>

<task type="auto">
  <name>Task 3: Convert \dontrun{} to runnable examples</name>
  <files>R/validate.R, R/hrf-formula.R, R/contrast.R</files>
  <action>
Convert 4 \dontrun{} blocks to fully runnable examples by including necessary setup code.

**R/validate.R - validate_contrasts() (lines 26-38):**
Replace the \dontrun{} example with:
```r
#' @examples
#' # Create a simple event model
#' des <- data.frame(
#'   onset = c(0, 10, 20, 30),
#'   run = 1,
#'   cond = factor(c("A", "B", "A", "B"))
#' )
#' sframe <- fmrihrf::sampling_frame(blocklens = 40, TR = 1)
#' emod <- event_model(onset ~ hrf(cond), data = des, block = ~run,
#'                     sampling_frame = sframe)
#'
#' # Validate all attached contrasts on the model
#' res <- validate_contrasts(emod)
#' print(res)
#'
#' # Validate a custom vector against a model
#' dm <- design_matrix(emod)
#' v <- rep(0, ncol(dm))
#' v[1] <- 1
#' v[2] <- -1
#' res2 <- validate_contrasts(emod, weights = v)
#' print(res2)
```

**R/validate.R - check_collinearity() (lines 190-194):**
Replace the \dontrun{} example with:
```r
#' @examples
#' # Create a simple event model
#' des <- data.frame(
#'   onset = c(0, 10, 20, 30),
#'   run = 1,
#'   cond = factor(c("A", "B", "A", "B"))
#' )
#' sframe <- fmrihrf::sampling_frame(blocklens = 40, TR = 1)
#' emod <- event_model(onset ~ hrf(cond), data = des, block = ~run,
#'                     sampling_frame = sframe)
#'
#' # Check collinearity
#' res <- check_collinearity(design_matrix(emod), threshold = 0.95)
#' res$ok
#' if (!res$ok) print(res$pairs)
```

**R/hrf-formula.R - boxcar_hrf_gen() (lines 508-523):**
Replace the \dontrun{} example with:
```r
#' @examples
#' # Events with variable durations
#' trial_data <- data.frame(
#'   onset = c(0, 10, 25),
#'   duration = c(2, 5, 3),
#'   condition = factor(c("A", "B", "A")),
#'   run = 1
#' )
#' sf <- fmrihrf::sampling_frame(blocklens = 50, TR = 2)
#'
#' emod <- event_model(
#'   onset ~ hrf(condition, hrf_fun = boxcar_hrf_gen()),
#'   data = trial_data, block = ~run, sampling_frame = sf,
#'   durations = trial_data$duration
#' )
#' print(emod)
```

**R/hrf-formula.R - weighted_hrf_gen() (lines 551-566):**
Replace the \dontrun{} example with:
```r
#' @examples
#' # Events with internal temporal structure
#' trial_data <- data.frame(
#'   onset = c(0, 20),
#'   sub_times = I(list(c(0, 1, 2), c(0, 3, 6))),
#'   sub_weights = I(list(c(0.2, 0.5, 0.3), c(0.1, 0.6, 0.3))),
#'   run = 1
#' )
#' sf <- fmrihrf::sampling_frame(blocklens = 50, TR = 2)
#'
#' emod <- event_model(
#'   onset ~ hrf(onset, hrf_fun = weighted_hrf_gen("sub_times", "sub_weights",
#'                                                  relative = TRUE)),
#'   data = trial_data, block = ~run, sampling_frame = sf
#' )
#' print(emod)
```

**Keep \dontrun{} for R/extension_registry.R - register_hrfspec_extension()** - This legitimately requires external package context that cannot be simulated.

**Keep \dontrun{} for R/contrast.R - translate_legacy_pattern()** - This is an internal function (@keywords internal) and the example is illustrative only.

After making changes, run devtools::document() to regenerate .Rd files.
  </action>
  <verify>Rscript -e "devtools::document(); devtools::run_examples(run_donttest = FALSE)" 2>&1 | tail -30</verify>
  <done>Only register_hrfspec_extension() and translate_legacy_pattern() use \dontrun{}; all other examples run successfully</done>
</task>

</tasks>

<verification>
After all tasks complete, run the full verification suite:

```r
# 1. Regenerate documentation
devtools::document()

# 2. Check spelling
result <- spelling::spell_check_package()
stopifnot(nrow(result) == 0)

# 3. Check URLs
urlchecker::url_check()

# 4. Run all examples
devtools::run_examples(run_donttest = FALSE)

# 5. Run package check (should show no new warnings related to documentation)
devtools::check(document = FALSE, args = c('--no-tests', '--no-vignettes'))
```

Expected outcomes:
- spelling::spell_check_package() returns 0 rows
- urlchecker::url_check() returns all OK
- devtools::run_examples() completes without errors
- devtools::check() shows no documentation-related warnings
</verification>

<success_criteria>
1. inst/WORDLIST exists with ~70 technical terms
2. spelling::spell_check_package() returns zero errors
3. residualize-methods.Rd has @return and @examples sections
4. validate_contrasts() example runs without error
5. check_collinearity() example runs without error
6. boxcar_hrf_gen() example runs without error
7. weighted_hrf_gen() example runs without error
8. Only 2 \dontrun{} remain (register_hrfspec_extension, translate_legacy_pattern)
9. devtools::run_examples() completes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-documentation-quality/01-01-SUMMARY.md`
</output>
