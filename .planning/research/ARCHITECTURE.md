# Architecture Patterns: CRAN R Package Structure

**Domain:** R package development for CRAN submission
**Researched:** 2026-01-25
**Confidence:** HIGH

## Executive Summary

CRAN R packages follow a standardized directory structure defined in the official "Writing R Extensions" manual. The structure balances mandatory requirements (DESCRIPTION, NAMESPACE, R/, man/) with optional but recommended components (tests/, vignettes/, NEWS.md, inst/CITATION). Package submission requires passing R CMD check without errors or warnings, proper documentation, and compliance with CRAN Repository Policy.

The fmridesign package already has most required components in place. Key missing elements for CRAN readiness: NEWS.md file (for version history) and potentially inst/CITATION (for academic citation).

## Required Package Structure

### Mandatory Files and Directories

These MUST exist for a valid R package:

| Component | Location | Purpose | Requirements |
|-----------|----------|---------|--------------|
| **DESCRIPTION** | `./DESCRIPTION` | Package metadata | See detailed field requirements below |
| **NAMESPACE** | `./NAMESPACE` | Import/export control | Generated by roxygen2, manual editing not recommended |
| **R/** | `./R/*.R` | R source code | Files must start with ASCII letter/digit, extensions: .R, .S, .q, .r, .s (recommend .R) |
| **man/** | `./man/*.Rd` | Function documentation | Files must start with ASCII letter/digit, extensions: .Rd or .rd (recommend .Rd) |

**Status for fmridesign:** All mandatory components present and properly structured.

### Highly Recommended Files

These are optional but expected for CRAN packages:

| Component | Location | Purpose | CRAN Expectation |
|-----------|----------|---------|------------------|
| **LICENSE** | `./LICENSE` | Full license text | Required if License field uses + file |
| **README.md** | `./README.md` | Package overview | Not installed, but expected for GitHub/CRAN display |
| **NEWS.md** | `./NEWS.md` | Version history | Strongly recommended, displays on CRAN |
| **.Rbuildignore** | `./.Rbuildignore` | Build exclusions | Required to exclude dev files |
| **tests/** | `./tests/testthat/` | Unit tests | Not mandatory but strongly expected |
| **vignettes/** | `./vignettes/*.Rmd` | Long-form documentation | Highly valued by CRAN, demonstrates usage |

**Status for fmridesign:**
- Present: LICENSE (implied), README.md, .Rbuildignore, tests/, vignettes/
- Missing: NEWS.md (needs creation)

### Optional but Valuable

| Component | Location | Purpose | When to Include |
|-----------|----------|---------|-----------------|
| **inst/CITATION** | `./inst/CITATION` | Citation information | Recommended for academic packages |
| **data/** | `./data/*.rda` | Example datasets | If package provides data |
| **data-raw/** | `./data-raw/*.R` | Data generation scripts | If data/ exists, document how data was created |
| **src/** | `./src/*.c, *.cpp` | Compiled code | If package uses C/C++/Fortran |
| **inst/** | `./inst/*` | Arbitrary files to install | Additional resources, templates, etc. |

**Status for fmridesign:**
- Present: data-raw/, inst/ (empty)
- Consider: inst/CITATION (recommended for academic software)

### Files to Exclude from Build

| Component | Location | Purpose |
|-----------|----------|---------|
| **.Rproj** | `./*.Rproj` | RStudio project file |
| **.Rproj.user/** | `./.Rproj.user/` | RStudio temporary files |
| **docs/** | `./docs/` | pkgdown website |
| **.github/** | `./.github/` | GitHub Actions workflows |
| **cran-comments.md** | `./cran-comments.md` | CRAN submission notes |

These must be listed in `.Rbuildignore` using Perl-compatible regular expressions.

## DESCRIPTION File Requirements

### Mandatory Fields

Per "Writing R Extensions," the DESCRIPTION file must contain:

| Field | Requirements | Example |
|-------|--------------|---------|
| **Package** | ASCII letters, numbers, dot; ≥2 chars; starts with letter; no trailing dot | `Package: fmridesign` |
| **Version** | ≥2 integers separated by . or - | `Version: 0.5.0` |
| **Title** | Short description, title case | `Title: Design Matrix Construction for fMRI Analysis` |
| **Description** | Detailed description (2+ sentences) | See current DESCRIPTION |
| **License** | Valid license identifier | `License: GPL (>= 2)` |
| **Author** / **Authors@R** | Package authors | Use Authors@R format (see below) |
| **Maintainer** | Single person with email | Auto-generated from Authors@R with role "cre" |

**Current fmridesign status:** All mandatory fields present and correct.

### Authors@R Format

Preferred over separate Author/Maintainer fields:

```r
Authors@R: person("Given", "Family",
                  role = c("aut", "cre"),
                  email = "email@domain.com",
                  comment = c(ORCID = "0000-0000-0000-0000"))
```

Roles:
- `"aut"` = author
- `"cre"` = creator/maintainer (required for CRAN contact)
- `"ctb"` = contributor
- `"cph"` = copyright holder

**Current fmridesign status:** Uses Authors@R with proper roles.

### Dependency Fields

| Field | Purpose | When to Use |
|-------|---------|-------------|
| **Depends** | Packages loaded when your package loads | Only for R version requirement and essential package attachments |
| **Imports** | Packages whose functions you use | Most dependencies go here (preferred) |
| **Suggests** | Optional packages | testthat, knitr, rmarkdown, covr |
| **LinkingTo** | C/C++ header dependencies | Rcpp, RcppArmadillo, etc. |
| **Enhances** | Packages enhanced by yours | Rarely used |

**Best practice:** Use `Imports` for all runtime dependencies, `Suggests` for testing/vignettes.

**Current fmridesign status:** Properly uses Depends (R version), Imports (runtime), Suggests (dev tools).

### Recommended Additional Fields

| Field | Purpose | Example |
|-------|---------|---------|
| **URL** | Package website, GitHub | `URL: https://github.com/user/pkg` |
| **BugReports** | Issue tracker | `BugReports: https://github.com/user/pkg/issues` |
| **Encoding** | Character encoding | `Encoding: UTF-8` (standard) |
| **LazyData** | Lazy-load data/ | `LazyData: true` (if data/ exists) |
| **VignetteBuilder** | Vignette engine | `VignetteBuilder: knitr` |
| **RoxygenNote** | roxygen2 version | Auto-added by roxygen2 |
| **Roxygen** | roxygen2 config | `Roxygen: list(markdown = TRUE)` |

**Current fmridesign status:** All recommended fields present. Note: LazyData: false is correct if no data/ directory with user-facing datasets.

### Custom Fields

Any custom field should start with `Config/` to avoid future conflicts:

```
Config/testthat/edition: 3
Config/Needs/website: bbuchsbaum/albersdown
```

**Current fmridesign status:** Properly uses Config/ prefix.

## NAMESPACE Management

### Generation with roxygen2

**CRITICAL:** Do NOT hand-edit NAMESPACE. Let roxygen2 generate it.

```r
# In R source files:
#' @export
my_function <- function() {}

#' @importFrom dplyr mutate filter
#' @importFrom rlang .data

# Then:
devtools::document()
```

### Key roxygen2 Tags for NAMESPACE

| Tag | Purpose | Example |
|-----|---------|---------|
| `@export` | Export function | `#' @export` |
| `@importFrom pkg fun` | Import specific function | `#' @importFrom dplyr filter` |
| `@import pkg` | Import entire package (avoid) | `#' @import ggplot2` |
| `@rawNamespace` | Raw NAMESPACE directive | For complex exports |

### S3 Method Registration

All S3 methods must be registered with `@export`, even if the generic is not exported:

```r
#' @export
print.my_class <- function(x, ...) {}
```

roxygen2 automatically generates the correct `S3method()` directive.

**Current fmridesign status:** NAMESPACE is roxygen2-generated with 223 S3method entries (first 50 shown in examination). Properly structured.

## Tests Directory Structure

### Standard testthat Layout

```
tests/
  testthat.R          # Test runner (standard boilerplate)
  testthat/
    test-feature1.R   # Test files start with test-
    test-feature2.R
    helper-utils.R    # Helper files start with helper-
    setup.R           # Setup file (if needed)
    _snaps/           # Snapshot tests (testthat 3e)
```

### testthat.R Contents

Standard boilerplate:

```r
library(testthat)
library(fmridesign)

test_check("fmridesign")
```

### DESCRIPTION Requirements

For testthat 3rd edition (current standard):

```
Suggests: testthat (>= 3.0.0)
Config/testthat/edition: 3
```

**Current fmridesign status:** Has tests/testthat/ structure with test files. Should verify testthat edition in DESCRIPTION.

## Vignettes Requirements

### Directory Structure

```
vignettes/
  my-vignette.Rmd
  another-vignette.Rmd
  .gitignore         # Ignore built vignettes
```

### YAML Metadata Required

Each .Rmd vignette must include:

```yaml
---
title: "Vignette Title"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```

### DESCRIPTION Requirements

```
Suggests: knitr, rmarkdown
VignetteBuilder: knitr
```

If using `knitr::rmarkdown` engine, both knitr AND rmarkdown must be in Suggests.

### Size Considerations

- Use `output: rmarkdown::html_vignette` (not html_document) for smaller file size
- CRAN prefers lightweight vignettes (html_vignette ~10KB vs html_document ~600KB)
- Large vignettes may trigger CRAN warnings

**Current fmridesign status:** Has 4 vignettes with proper DESCRIPTION fields. Should verify YAML metadata includes required vignette tags.

## NEWS.md Format

### Structure

```markdown
# fmridesign 0.5.0

* Major feature 1
* Bug fix description
* Breaking change warning

# fmridesign 0.4.0

* Previous version changes
```

### Heading Formats (any valid)

- `fmridesign 1.3.0`
- `fmridesign v1.3.0`
- `Version 1.3.0`
- `Changes in 1.3.0`
- `# fmridesign 0.5.0 (2025-06-28)` (with ISO date)

### Best Practices

- Top-level heading for each version
- Optional second-level headings for categories (Breaking changes, New features, Bug fixes)
- Most recent version at top
- User-visible changes only
- Keep for historical reference (don't delete old versions)

### CRAN Display

- NEWS.md is parsed by CRAN and displayed on package landing page
- Also used by pkgdown for changelog page
- Used for GitHub release descriptions

**Current fmridesign status:** NEWS.md is MISSING. Should be created before CRAN submission.

## inst/CITATION Format

Optional but recommended for academic packages.

### File Structure

Located at `inst/CITATION` (no file extension).

R code that creates bibentry objects:

```r
bibentry(
  bibtype = "Manual",
  title = "fmridesign: Design Matrix Construction for fMRI Analysis",
  author = person("Bradley", "Buchsbaum"),
  year = "2025",
  note = "R package version 0.5.0",
  url = "https://github.com/bbuchsbaum/fmridesign"
)
```

For published papers:

```r
bibentry(
  bibtype = "Article",
  title = "Paper Title",
  author = c(person("Bradley", "Buchsbaum")),
  journal = "Journal Name",
  year = "2024",
  volume = "10",
  pages = "1-20",
  doi = "10.1234/journal.2024.001"
)
```

### Usage

Users cite with: `citation("fmridesign")`

**Current fmridesign status:** inst/CITATION does NOT exist. Consider adding for academic software.

## .Rbuildignore Patterns

### Required Patterns

```perl
^.*\.Rproj$              # RStudio project
^\.Rproj\.user$          # RStudio temp files
^README\.Rmd$            # Source for README.md
^\.github$               # GitHub Actions
^\.git$                  # Git directory
^\.gitignore$            # Git config
^docs$                   # pkgdown site
^_pkgdown\.yml$          # pkgdown config
^pkgdown$                # pkgdown cache
^cran-comments\.md$      # CRAN submission notes
^\.travis\.yml$          # Travis CI (legacy)
^\.covrignore$           # Coverage config
^codecov\.yml$           # Codecov config
^\.DS_Store$             # macOS files
^data-raw$               # Data generation scripts
```

### Pattern Rules

- Each line is a Perl-compatible regular expression
- Case-insensitive matching
- Use `^` to anchor at start, `$` at end
- Escape dots: `\.` not `.`
- Use `usethis::use_build_ignore()` to add patterns safely

**Current fmridesign status:** .Rbuildignore exists with comprehensive patterns. Should verify all development artifacts are excluded.

## Data Directory Structure

### For User-Facing Data

```
data/
  dataset1.rda        # save(dataset1, file = "data/dataset1.rda")
  dataset2.rda
```

### DESCRIPTION Settings

```
LazyData: true
LazyDataCompression: xz
```

- `LazyData: true` = data available immediately when package loads
- Compression: `xz` for datasets > 5MB (CRAN will warn otherwise)

### For Internal/System Data

```
R/
  sysdata.rda         # save(internal_data, file = "R/sysdata.rda")
```

Not exported, available only to package functions.

### Data Documentation

Each dataset needs documentation in `R/data.R`:

```r
#' Dataset Title
#'
#' Description of the dataset.
#'
#' @format A data frame with X rows and Y variables:
#' \describe{
#'   \item{var1}{Description of var1}
#'   \item{var2}{Description of var2}
#' }
#' @source \url{http://data-source.com}
"dataset_name"
```

**Current fmridesign status:** LazyData: false in DESCRIPTION, suggesting no user-facing data/ directory (correct). Has data-raw/ for data generation scripts.

## CRAN Submission Requirements

### Pre-Submission Checklist

1. **R CMD check must pass cleanly:**
   - 0 errors
   - 0 warnings
   - 0 significant notes (minor notes like package size are acceptable)

2. **Version requirements:**
   - New packages: Start with 0.1.0 or 1.0.0
   - Updates: Version must be higher than CRAN version

3. **Size limitations:**
   - Source tarball: < 10MB if possible
   - Larger packages need justification

4. **Documentation:**
   - Every exported function documented
   - Examples that run successfully
   - Vignettes build without error

5. **Copyright clarity:**
   - All code ownership clear
   - License compatible with CRAN
   - No ambiguous licensing

### Submission Process

1. Run `devtools::check()` locally - MUST pass
2. Run `rhub::check_for_cran()` - test on CRAN-like systems
3. Run `revdepcheck::revdep_check()` - if package has dependents
4. Create cran-comments.md documenting test results
5. Submit via web form: https://cran.r-project.org/submit.html
6. Respond to CRAN feedback within 2 weeks

### Update Frequency

- Established packages: Maximum every 1-2 months
- Breaking changes: Give dependents ≥2 weeks notice
- Respect CRAN volunteer time

### Communication

- Use CRAN-submissions@R-project.org for new submissions
- Use CRAN@R-project.org for published package updates
- Plain text ASCII only (no HTML)
- Do not contact individual CRAN members

## Anti-Patterns to Avoid

### Anti-Pattern 1: Hand-Editing NAMESPACE

**What:** Manually editing the NAMESPACE file
**Why bad:** Conflicts with roxygen2, hard to maintain, error-prone
**Instead:** Use roxygen2 tags in R source files, generate with `devtools::document()`

### Anti-Pattern 2: Not Using .Rbuildignore

**What:** Development files included in package build
**Why bad:** Inflates package size, may cause check failures, unprofessional
**Instead:** Add all dev files to .Rbuildignore (RStudio project, docs/, .github/, etc.)

### Anti-Pattern 3: Missing or Incomplete DESCRIPTION

**What:** Missing mandatory fields, no Authors@R, unclear dependencies
**Why bad:** CRAN rejection, installation problems, unclear authorship
**Instead:** Use complete Authors@R, specify all dependencies correctly

### Anti-Pattern 4: Tests That Require External Resources

**What:** Tests that need internet, specific files, or services
**Why bad:** CRAN checks run offline, tests will fail, package rejected
**Instead:** Skip tests conditionally with `testthat::skip_if_offline()`, use mock data

### Anti-Pattern 5: Examples That Don't Run

**What:** Examples that error, require unavailable data, or take too long
**Why bad:** R CMD check fails, CRAN rejection
**Instead:** Use `\dontrun{}` for non-runnable examples, `\donttest{}` for slow examples, ensure examples work

### Anti-Pattern 6: Vignettes That Fail to Build

**What:** Vignettes with errors, missing dependencies, or external requirements
**Why bad:** R CMD check fails on CRAN, package rejected
**Instead:** Test vignette builds locally, use conditional code for optional features

### Anti-Pattern 7: Using `library()` in Package Code

**What:** Calling `library(package)` in R/ source files
**Why bad:** Attaches package to search path, side effects, namespace pollution
**Instead:** Use `package::function()` or `@importFrom` with NAMESPACE imports

### Anti-Pattern 8: No Version History

**What:** No NEWS.md file, unclear what changed between versions
**Why bad:** Users confused about changes, harder to debug version-specific issues
**Instead:** Maintain NEWS.md with user-visible changes for each version

## CRAN Policy Summary

Key points from CRAN Repository Policy:

| Policy Area | Requirement |
|-------------|-------------|
| **Quality** | Publication quality, non-trivial contribution, passes R CMD check |
| **Maintainer** | Single person with valid email, must respond to CRAN team |
| **Copyright** | Clear ownership of all components |
| **Updates** | Responsible frequency (≤every 1-2 months), coordinate breaking changes |
| **Size** | Source tarball preferably < 10MB |
| **License** | Valid open source license |
| **Communication** | Plain text ASCII to official CRAN addresses only |

## Confidence Assessment

| Area | Confidence | Source |
|------|------------|--------|
| Required structure | HIGH | Official "Writing R Extensions" manual, verified via WebSearch |
| DESCRIPTION fields | HIGH | CRAN documentation, R Packages book |
| NAMESPACE practices | HIGH | roxygen2 documentation, current vignettes |
| Testing structure | HIGH | testthat 3.3.2 documentation (Jan 2026) |
| Vignette requirements | HIGH | CRAN manual, rmarkdown documentation |
| NEWS.md format | MEDIUM | Community best practices, multiple sources |
| CITATION format | MEDIUM | R manual documentation, examples |
| CRAN policies | HIGH | Official CRAN Repository Policy |

## Package-Specific Assessment: fmridesign

### Current State

**Compliant components:**
- DESCRIPTION: Complete with all required fields
- NAMESPACE: roxygen2-generated, proper S3 method registration
- R/: 23 source files, properly structured
- man/: 102 documentation files (4,194 lines total)
- tests/testthat/: Test infrastructure in place
- vignettes/: 4 vignettes with proper DESCRIPTION setup
- .Rbuildignore: Comprehensive exclusion patterns
- README.md: Present

**Gaps for CRAN submission:**
1. NEWS.md: MISSING - needs creation with version history
2. inst/CITATION: Empty directory - consider adding citation file
3. Verify vignettes have proper YAML metadata with VignetteIndexEntry
4. Verify testthat edition is 3 in DESCRIPTION

### Recommended Actions

1. **Create NEWS.md** (HIGH priority)
   - Document changes in version 0.5.0
   - Include user-visible features, bug fixes, breaking changes
   - Use standard format for CRAN display

2. **Add inst/CITATION** (MEDIUM priority)
   - Create bibentry for package citation
   - Important for academic software in neuroimaging domain
   - Enhances professional presentation

3. **Verify vignette metadata** (LOW priority)
   - Check all .Rmd files have VignetteIndexEntry, VignetteEngine, VignetteEncoding
   - Ensure vignettes build successfully

4. **Run full CRAN check** (HIGH priority)
   - `devtools::check()` locally
   - `rhub::check_for_cran()` for CRAN-like systems
   - Address any warnings or notes

## Sources

- [Writing R Extensions (CRAN official)](https://cran.r-project.org/doc/manuals/r-release/R-exts.html)
- [CRAN Repository Policy](https://cran.r-project.org/web/packages/policies.html)
- [CRAN Submission Checklist](https://cran.r-project.org/web/packages/submission_checklist.html)
- [R Packages (2e) - Structure](https://r-pkgs.org/structure.html)
- [R Packages (2e) - DESCRIPTION](https://r-pkgs.org/description.html)
- [R Packages (2e) - Vignettes](https://r-pkgs.org/vignettes.html)
- [R Packages (2e) - Data](https://r-pkgs.org/data.html)
- [R Packages (2e) - Testing](https://r-pkgs.org/testing-basics.html)
- [R Packages (2e) - Other Markdown Files](https://r-pkgs.org/other-markdown.html)
- [R Packages (2e) - Releasing to CRAN](https://r-pkgs.org/release.html)
- [roxygen2 - Managing Imports and Exports](https://cran.r-project.org/web/packages/roxygen2/vignettes/namespace.html)
- [testthat Package Documentation](https://testthat.r-lib.org/)
- [R-hub Blog - Non-standard Files and .Rbuildignore](https://blog.r-hub.io/2020/05/20/rbuildignore/)
- [R-hub Blog - Package NEWS Files](https://blog.r-hub.io/2020/05/08/pkg-news/)
- [R-hub Blog - Optimal Vignette Workflows](https://blog.r-hub.io/2020/06/03/vignettes/)
- [DESCRIPTION File Issues (CRAN Cookbook)](https://contributor.r-project.org/cran-cookbook/description_issues.html)
