# Codebase Structure

**Analysis Date:** 2025-01-25

## Directory Layout

```
fmridesign/
├── R/                           # Source code (R package)
│   ├── design_generics.R        # Generic function definitions
│   ├── event_model.R            # Main event_model constructor (3-stage pipeline)
│   ├── event_model_helpers.R    # Parser and realiser helper functions
│   ├── event_vector.R           # event_term and event constructors, convolve methods
│   ├── event-classes.R          # Internal event class definition and factory
│   ├── baseline_model.R         # baseline_model constructor and methods
│   ├── hrf-formula.R            # hrf(), trialwise(), covariate() formula functions
│   ├── contrast.R               # Contrast specification and manipulation
│   ├── basis.R                  # Parametric basis classes (Poly, Scale, BSpline)
│   ├── design_map.R             # Visualization of design matrices
│   ├── design_colmap.R          # Column metadata mapping
│   ├── naming-utils.R           # Column naming utilities, clash resolution
│   ├── validate.R               # Input validation helpers
│   ├── utils-internal.R         # Internal utilities (.sanitizeName, .checkEVArgs, etc.)
│   ├── extension_registry.R     # Registry for external HRF functions
│   ├── condition_basis_list.R   # Condition/basis combinations
│   ├── covariate.R              # Covariate term specification
│   ├── residualize.R            # Project data onto design orthogonal complement
│   ├── sampling_frame.R         # Print and plot methods for sampling_frame
│   ├── fmrihrf-imports.R        # Imports from fmrihrf dependency
│   ├── fmrihrf-reexports.R      # Re-exports from fmrihrf
│   ├── globals.R                # Global options and constants
│   ├── namespace-imports.R      # Namespace configuration
│   └── (23 files total)
├── tests/
│   └── testthat/                # Test suite directory
│       ├── test_event_model.R   # Tests for event_model constructor
│       ├── test_baseline.R      # Tests for baseline_model
│       ├── test_event_vector.R  # Tests for event_term and event classes
│       ├── test_hrf.R           # Tests for HRF integration
│       ├── test_hrf_generator.R # Tests for per-onset HRF generators
│       ├── test_contrast.R      # Tests for contrast specifications
│       ├── test_parse_*.R       # Tests for formula parsing
│       ├── test-naming-utils.R  # Tests for column naming
│       ├── test_basic_*.R       # Integration tests
│       ├── helper-naming.R      # Test helpers
│       └── (15+ test files)
├── vignettes/                   # Documentation and examples
│   ├── *.Rmd                    # Package vignettes
├── man/                         # Generated roxygen2 documentation
├── docs/                        # Built pkgdown website
├── DESCRIPTION                  # Package metadata
├── NAMESPACE                    # Exports and imports
├── CLAUDE.md                    # Development instructions
└── .planning/                   # Planning documents
    └── codebase/                # Architecture analysis (this directory)
```

## Directory Purposes

**R/ (Source Code):**
- Purpose: All package functionality organized by concept
- Contains: R functions, S3 class definitions, generic methods
- Key files: event_model.R, baseline_model.R, event_vector.R, hrf-formula.R

**tests/testthat/ (Tests):**
- Purpose: Unit and integration tests for all major components
- Contains: Test files matching test_*.R pattern, helper utilities
- Key files: test_event_model.R (main constructor), test_event_vector.R (event classes)

**vignettes/ (Documentation):**
- Purpose: Long-form documentation and usage examples
- Contains: .Rmd files with worked examples
- Built into: pkgdown website (docs/)

**man/ (Roxygen2 Documentation):**
- Purpose: Auto-generated function documentation
- Auto-maintained by devtools::document()

**docs/ (Website):**
- Purpose: Built pkgdown website
- Auto-generated by devtools::build_site()

## Key File Locations

**Entry Points:**
- `R/event_model.R`: Main constructor implementing 3-stage pipeline
- `R/baseline_model.R`: Baseline model constructor
- `R/hrf-formula.R`: Formula specification functions (hrf(), trialwise(), covariate())

**Configuration:**
- `DESCRIPTION`: Package metadata, dependencies, collation order
- `NAMESPACE`: Function exports and external imports
- `.planning/codebase/`: This directory with architecture documents

**Core Logic:**
- `R/event_model_helpers.R`: Formula parsing (parse_event_formula) and term realisation (realise_event_terms)
- `R/event_vector.R`: Event construction and convolve implementations
- `R/event-classes.R`: Internal event class factory
- `R/baseline_model.R`: Baseline matrix assembly and nuisance handling

**Testing:**
- `tests/testthat/test_event_model.R`: Primary event_model tests
- `tests/testthat/test_event_vector.R`: Event class tests
- `tests/testthat/test_baseline.R`: Baseline model tests
- `tests/testthat/helper-naming.R`: Test utilities

## Naming Conventions

**Files:**
- Concept-based: `event_model.R`, `baseline_model.R` (main components)
- Hyphenated for sub-components: `event-classes.R`, `design_generics.R`
- Utility modules: `naming-utils.R`, `utils-internal.R`
- Test files: `test_*.R` or `test-*.R` (both patterns used)

**Directories:**
- `R/` for source (R convention)
- `tests/testthat/` for tests (testthat convention)
- `vignettes/` for long-form docs (R convention)
- `man/` for function documentation (generated)

**Functions:**
- Public APIs: camelCase `event_model()`, `baseline_model()`, `hrf()`, `convolve()`
- Internal helpers: dot prefix `.checkEVArgs()`, `.sanitizeName()`, or regular camelCase in utils
- Generics: descriptive verbs `design_matrix()`, `conditions()`, `elements()`

**S3 Classes:**
- PascalCase for basis classes: `Poly`, `Scale`, `BSpline`
- snake_case for design classes: `event_model`, `baseline_model`, `event_term`, `event`
- Spec objects: `hrfspec`, `baselinespec`, `covariatespec`

## Where to Add New Code

**New Feature (Event-Related):**
- Primary code: `R/event_model.R` or `R/event_model_helpers.R` (for pipeline extensions)
- Tests: `tests/testthat/test_event_model.R` or new `test_[feature].R`
- Example: Adding new HRF basis would modify `R/hrf-formula.R` in `make_hrf()` function

**New Component/Module:**
- Implementation: Create `R/component_name.R` matching the concept
- Methods: Add S3 methods in the same file or in `design_generics.R`
- Tests: Create `tests/testthat/test_component_name.R`
- Export: Add function names to NAMESPACE via roxygen2 `@export`

**Utilities:**
- Shared helpers: `R/utils-internal.R` (internal) or `R/naming-utils.R` (if naming-specific)
- Validation: Add to `R/validate.R` if validation-related
- Naming: Add to `R/naming-utils.R` for column naming logic

**Tests:**
- Follow testthat pattern: one file per major component
- Location: `tests/testthat/test_[component].R`
- Setup: Use local_edition(3) for edition 3 features
- Helpers: Reusable test data and functions in `tests/testthat/helper-*.R`

## Special Directories

**R/:**
- Purpose: All executable code
- Generated: No (manually maintained)
- Committed: Yes
- Collation order critical (see DESCRIPTION Collate field)

**tests/testthat/:**
- Purpose: Test definitions and fixtures
- Generated: No
- Committed: Yes
- Run via: devtools::test() or testthat::test_dir()

**man/:**
- Purpose: Auto-generated documentation
- Generated: Yes (by devtools::document())
- Committed: Yes
- Maintain via: roxygen2 comments in R/*.R files

**docs/:**
- Purpose: Built website (pkgdown)
- Generated: Yes (by devtools::build_site() or pkgdown::build_site())
- Committed: Yes (deployed to GitHub Pages)
- Maintenance: Automatic from vignettes/ and man/

**.planning/codebase/:**
- Purpose: Architecture and planning documents
- Generated: No (manually maintained)
- Committed: Yes
- Files:
  - ARCHITECTURE.md: Design patterns, layers, data flow
  - STRUCTURE.md: This file - directory layout and where to add code
  - (Other docs added by /gsd:map-codebase commands)

## Collation Order (from DESCRIPTION)

The DESCRIPTION file specifies R file load order:
1. `baseline_model.R`
2. `basis.R`
3. `condition_basis_list.R`
4. `contrast.R`
5. `covariate.R`
6. `design_colmap.R`
7. `design_generics.R` (generics must be early)
8. `design_map.R`
9. `utils-internal.R` (helpers before users)
10. `event-classes.R` (internal event classes)
11. `event_model_helpers.R` (helpers for main constructor)
12. `event_model.R` (main constructor, depends on helpers)
13. `event_vector.R` (event constructors, uses event-classes)
14. `extension_registry.R`
15. `fmrihrf-imports.R`
16. `fmrihrf-reexports.R`
17. `globals.R`
18. `hrf-formula.R`
19. `namespace-imports.R`
20. `naming-utils.R`
21. `residualize.R`
22. `sampling_frame.R`
23. `validate.R`

**Critical:** When adding new files, update DESCRIPTION Collate field to maintain this order.

## Design Patterns in File Organization

**One Component Per File:**
- Each major concept (event_model, baseline_model, event_term) has its own file
- Related utilities grouped: naming-utils.R, utils-internal.R

**Generics First:**
- design_generics.R loaded early (stage 7 of 23)
- All other files implement these generics

**Dependency Chain:**
- utils-internal.R early (stage 9) for shared helpers
- event-classes.R early (stage 10) for internal classes
- event_model_helpers.R and event_model.R late (stages 11-12) after dependencies

**Test Structure:**
- Test files mirror source organization
- test_event_model.R, test_baseline.R, test_event_vector.R match main components
- test_hrf.R tests formula functions from hrf-formula.R
- test_contrast.R tests contrast.R

---

*Structure analysis: 2025-01-25*
