<?xml version="1.0" encoding="UTF-8"?>
<golden_test xmlns="http://golden-tests.org/schema">
  <metadata>
    <id>event_model_basic_hrf</id>
    <version>1.0</version>
    <description>Test basic HRF convolution with two conditions</description>
    <tags>
      <tag>event_model</tag>
      <tag>hrf</tag>
      <tag>convolution</tag>
      <tag>canonical</tag>
    </tags>
  </metadata>
  
  <semantic_description>
    <purpose>Verify that event onsets are correctly convolved with the canonical HRF to produce expected BOLD response curves</purpose>
    <algorithm>
      1. Define two event conditions (A and B) with specific onset times
      2. Create a canonical hemodynamic response function (HRF)
      3. Convolve each condition's events with the HRF
      4. Sample the convolved signals at TR intervals
      5. Construct a design matrix with one column per condition
      6. Verify that peak responses occur at expected delays (~5-6s post-stimulus)
      7. Verify that responses sum to approximately 1.0 (normalized HRF)
    </algorithm>
    <references>
      <reference>Friston et al. (1998). Event-related fMRI: characterizing differential responses. NeuroImage, 7(1), 30-40.</reference>
    </references>
  </semantic_description>
  
  <inputs>
    <sampling_frame>
      <block_lengths>100</block_lengths>
      <TR>2.0</TR>
    </sampling_frame>
    
    <events>
      <event>
        <onset>10.0</onset>
        <condition>A</condition>
        <block>1</block>
        <duration>0.0</duration>
      </event>
      <event>
        <onset>30.0</onset>
        <condition>B</condition>
        <block>1</block>
        <duration>0.0</duration>
      </event>
      <event>
        <onset>50.0</onset>
        <condition>A</condition>
        <block>1</block>
        <duration>0.0</duration>
      </event>
      <event>
        <onset>70.0</onset>
        <condition>B</condition>
        <block>1</block>
        <duration>0.0</duration>
      </event>
    </events>
    
    <model_params>
      <hrf_basis>canonical</hrf_basis>
      <precision>0.3</precision>
    </model_params>
  </inputs>
  
  <expected_outputs>
    <design_matrix>
      <dimensions>
        <rows>100</rows>
        <columns>2</columns>
      </dimensions>
      <column_names>
        <name>condition_condition.A</name>
        <name>condition_condition.B</name>
      </column_names>
      <numeric_checks>
        <!-- Check peak response for first event in condition A (onset=10s) -->
        <check>
          <type>peak_value</type>
          <location>
            <column>0</column>
            <row_range>7,9</row_range>
          </location>
          <expected>1.750</expected>
          <tolerance>0.01</tolerance>
          <description>Peak HRF response ~5-6s after onset at t=10s</description>
        </check>
        
        <!-- Check that column sums are approximately 9.83 (two events per condition) -->
        <check>
          <type>column_sum</type>
          <location>
            <column>0</column>
          </location>
          <expected>9.832</expected>
          <tolerance>0.05</tolerance>
          <description>Sum of HRF responses for two events in condition A</description>
        </check>
        
        <check>
          <type>column_sum</type>
          <location>
            <column>1</column>
          </location>
          <expected>9.823</expected>
          <tolerance>0.05</tolerance>
          <description>Sum of HRF responses for two events in condition B</description>
        </check>
        
        <!-- Check minimum value (undershoot) in HRF -->
        <check>
          <type>min</type>
          <location>
            <column>0</column>
          </location>
          <expected>-0.0104</expected>
          <tolerance>0.001</tolerance>
          <description>Minimum value (undershoot) in HRF</description>
        </check>
        
        <!-- Verify zero response before first event -->
        <check>
          <type>exact_value</type>
          <location>
            <column>0</column>
            <row>0</row>
          </location>
          <expected>0.0</expected>
          <tolerance>0.0001</tolerance>
          <description>No response before first event</description>
        </check>
      </numeric_checks>
    </design_matrix>
  </expected_outputs>
  
  <implementations>
    <R><![CDATA[
library(fmridesign)
library(fmrihrf)

# Create sampling frame
sframe <- sampling_frame(blocklens = 100, TR = 2.0)

# Create event data
event_data <- data.frame(
  onset = c(10.0, 30.0, 50.0, 70.0),
  condition = factor(c("A", "B", "A", "B")),
  block = c(1, 1, 1, 1)
)

# Create event model with canonical HRF
ev_model <- event_model(
  onset ~ hrf(condition),
  data = event_data,
  block = ~block,
  sampling_frame = sframe,
  precision = 0.3
)

# Get design matrix
dm <- design_matrix(ev_model)

# Convert to regular matrix for numeric checks
dm_matrix <- as.matrix(dm)
    ]]></R>
  </implementations>
</golden_test>