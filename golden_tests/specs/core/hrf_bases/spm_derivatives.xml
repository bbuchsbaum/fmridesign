<?xml version="1.0" encoding="UTF-8"?>
<golden_test xmlns="http://golden-tests.org/schema">
  <metadata>
    <id>hrf_bases_spm_derivatives</id>
    <version>1.0</version>
    <description>Test SPM HRF with temporal and dispersion derivatives</description>
    <tags>
      <tag>hrf</tag>
      <tag>spm</tag>
      <tag>derivatives</tag>
      <tag>basis_set</tag>
    </tags>
  </metadata>
  
  <semantic_description>
    <purpose>Verify correct implementation of SPM's HRF basis set with derivatives</purpose>
    <algorithm>
      1. Generate canonical HRF using double-gamma function
      2. Compute temporal derivative (1st derivative of HRF)
      3. Compute dispersion derivative (derivative w.r.t. width parameter)
      4. Orthogonalize derivatives with respect to canonical HRF
      5. Verify orthogonality and proper scaling of basis functions
    </algorithm>
    <references>
      <reference>Friston et al. (1998). Event-related fMRI: characterizing differential responses. NeuroImage, 7(1), 30-40.</reference>
      <reference>Henson et al. (2002). Detecting latency differences in event-related BOLD responses. NeuroImage, 15(1), 83-97.</reference>
    </references>
  </semantic_description>
  
  <inputs>
    <sampling_frame>
      <block_lengths>100</block_lengths>
      <TR>2.0</TR>
    </sampling_frame>
    
    <events>
      <event>
        <onset>20.0</onset>
        <condition>stimulus</condition>
        <block>1</block>
        <duration>0.0</duration>
      </event>
    </events>
    
    <model_params>
      <hrf_basis>spmg3</hrf_basis>  <!-- SPM canonical + temporal + dispersion derivatives -->
      <precision>0.1</precision>
    </model_params>
  </inputs>
  
  <expected_outputs>
    <design_matrix>
      <dimensions>
        <rows>100</rows>
        <columns>3</columns>
      </dimensions>
      <column_names>
        <name>condition_condition.stimulus_b01</name>  <!-- Canonical -->
        <name>condition_condition.stimulus_b02</name>  <!-- Temporal derivative -->
        <name>condition_condition.stimulus_b03</name>  <!-- Dispersion derivative -->
      </column_names>
      <numeric_checks>
        <!-- Check canonical HRF properties -->
        <check>
          <type>peak_value</type>
          <location>
            <column>0</column>
            <row_range>12,14</row_range>  <!-- Peak around 5-6s post-stimulus -->
          </location>
          <expected>1.752</expected>
          <tolerance>0.01</tolerance>
          <description>Canonical HRF peak value</description>
        </check>
        
        <check>
          <type>column_sum</type>
          <location>
            <column>0</column>
          </location>
          <expected>4.916</expected>
          <tolerance>0.01</tolerance>
          <description>Canonical HRF sums to expected value</description>
        </check>
        
        <!-- Check temporal derivative crosses zero near peak -->
        <check>
          <type>mean</type>
          <location>
            <column>1</column>
          </location>
          <expected>-0.0002</expected>
          <tolerance>0.01</tolerance>
          <description>Temporal derivative has zero mean</description>
        </check>
        
        <!-- Check dispersion derivative properties -->
        <check>
          <type>mean</type>
          <location>
            <column>2</column>
          </location>
          <expected>0.0004</expected>
          <tolerance>0.01</tolerance>
          <description>Dispersion derivative has zero mean</description>
        </check>
        
        <!-- Verify orthogonality via near-zero dot products -->
        <check>
          <type>max</type>
          <location>
            <column>1</column>
          </location>
          <expected>0.672</expected>
          <tolerance>0.01</tolerance>
          <description>Maximum of temporal derivative</description>
        </check>
        
        <check>
          <type>min</type>
          <location>
            <column>1</column>
          </location>
          <expected>-0.366</expected>
          <tolerance>0.01</tolerance>
          <description>Minimum of temporal derivative</description>
        </check>
      </numeric_checks>
    </design_matrix>
  </expected_outputs>
  
  <implementations>
    <R><![CDATA[
library(fmridesign)
library(fmrihrf)

# Create sampling frame
sframe <- sampling_frame(blocklens = 100, TR = 2.0)

# Create event data  
event_data <- data.frame(
  onset = 20.0,
  condition = factor("stimulus"),
  block = 1
)

# Create event model with SPM HRF + derivatives
ev_model <- event_model(
  onset ~ hrf(condition, basis = "spmg3"),
  data = event_data,
  block = ~block,
  sampling_frame = sframe,
  precision = 0.1
)

# Get design matrix
dm <- design_matrix(ev_model)

# Convert to regular matrix for numeric checks
dm_matrix <- as.matrix(dm)
    ]]></R>
  </implementations>
</golden_test>