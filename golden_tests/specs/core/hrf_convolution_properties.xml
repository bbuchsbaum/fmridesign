<?xml version="1.0" encoding="UTF-8"?>
<golden_test xmlns="http://golden-tests.org/schema">
  <metadata>
    <id>core_hrf_convolution_properties</id>
    <version>1.0</version>
    <description>Test fundamental mathematical properties of HRF convolution operations</description>
    <tags>
      <tag>hrf_convolution</tag>
      <tag>mathematical_properties</tag>
      <tag>signal_processing</tag>
      <tag>linearity</tag>
      <tag>cross_language</tag>
    </tags>
  </metadata>
  
  <semantic_description>
    <purpose>Verify that HRF convolution satisfies fundamental mathematical properties across implementations</purpose>
    <algorithm>
      1. Test linearity: conv(a*x + b*y) = a*conv(x) + b*conv(y)
      2. Test time-shifting: delayed events produce time-shifted responses
      3. Test superposition: overlapping events sum correctly
      4. Test impulse response: single event produces canonical HRF shape
      5. Test zero-padding: response decays to zero after sufficient time
      6. Verify numerical stability with very small and large amplitudes
    </algorithm>
    <mathematical_background>
      HRF convolution must satisfy fundamental signal processing properties:
      - Linearity: Linear combinations of inputs produce linear combinations of outputs
      - Time-invariance: Temporal shifts preserve response shape
      - Superposition: Multiple events sum without interference
      - Causality: No response before stimulus onset
      - Stability: Bounded inputs produce bounded outputs
      - Commutativity: Order of convolution operations doesn't matter
    </mathematical_background>
    <references>
      <reference>Oppenheim, A. V., &amp; Schafer, R. W. (2009). Discrete-Time Signal Processing. Pearson.</reference>
      <reference>Boynton, G. M., et al. (1996). Linear systems analysis of functional magnetic resonance imaging in human V1. Journal of Neuroscience, 16(13), 4207-4221.</reference>
    </references>
  </semantic_description>
  
  <inputs>
    <sampling_frame>
      <block_lengths>120</block_lengths>
      <TR>2.0</TR>
    </sampling_frame>
    
    <test_events>
      <!-- Test case 1: Single impulse at t=10s -->
      <event_set id="single_impulse">
        <event>
          <onset>10.0</onset>
          <condition>impulse</condition>
          <block>1</block>
          <duration>0.0</duration>
        </event>
      </event_set>
      
      <!-- Test case 2: Time-shift test -->
      <event_set id="time_shift_test">
        <event>
          <onset>40.0</onset>
          <condition>original</condition>
          <block>1</block>
          <duration>0.0</duration>
        </event>
        <event>
          <onset>50.0</onset>
          <condition>shifted</condition>
          <block>1</block>
          <duration>0.0</duration>
        </event>
      </event_set>
      
      <!-- Test case 3: Superposition test - close events for temporal overlap -->
      <event_set id="superposition_test">
        <event>
          <onset>80.0</onset>
          <condition>single</condition>
          <block>1</block>
          <duration>0.0</duration>
        </event>
        <event>
          <onset>82.0</onset>
          <condition>double_first</condition>
          <block>1</block>
          <duration>0.0</duration>
        </event>
        <event>
          <onset>84.0</onset>
          <condition>double_second</condition>
          <block>1</block>
          <duration>0.0</duration>
        </event>
      </event_set>
    </test_events>
    
    <model_params>
      <hrf_basis>canonical</hrf_basis>
      <precision>0.1</precision>
    </model_params>
  </inputs>
  
  <expected_outputs>
    <design_matrix>
      <dimensions>
        <rows>120</rows>
        <columns>6</columns>  <!-- impulse, original, shifted, single, double_first, double_second -->
      </dimensions>
      <column_names>
        <name>condition_condition.double_first</name>
        <name>condition_condition.double_second</name>
        <name>condition_condition.impulse</name>
        <name>condition_condition.original</name>
        <name>condition_condition.shifted</name>
        <name>condition_condition.single</name>
      </column_names>
      <numeric_checks>
        <!-- 1. IMPULSE RESPONSE: Single event should produce canonical HRF -->
        <check>
          <type>peak_value</type>
          <location>
            <column>2</column>  <!-- impulse condition (0-indexed) -->
            <row_range>7,8</row_range>  <!-- Peak at row 8 (t=14s) after t=10s onset -->
          </location>
          <expected>1.754</expected>
          <tolerance>0.01</tolerance>
          <description>Single impulse produces canonical HRF peak</description>
        </check>
        
        <check>
          <type>column_sum</type>
          <location>
            <column>2</column>  <!-- impulse condition -->
          </location>
          <expected>4.915</expected>
          <tolerance>0.01</tolerance>
          <description>Single impulse total response matches canonical HRF integral</description>
        </check>
        
        <!-- 2. TIME-INVARIANCE: Time-shifted events preserve response shape -->
        <check>
          <type>peak_value</type>
          <location>
            <column>3</column>  <!-- original at t=40s -->
            <row_range>22,23</row_range>  <!-- Peak at t=44s (row 23, 0-indexed 22) -->
          </location>
          <expected>1.754</expected>
          <tolerance>0.01</tolerance>
          <description>Time-invariance: Original event peak magnitude</description>
        </check>
        
        <check>
          <type>peak_value</type>
          <location>
            <column>4</column>  <!-- shifted at t=50s -->
            <row_range>27,28</row_range>  <!-- Peak at t=54s (row 28, 0-indexed 27) -->
          </location>
          <expected>1.754</expected>
          <tolerance>0.01</tolerance>
          <description>Time-invariance: Shifted event preserves peak magnitude</description>
        </check>
        
        <!-- 3. SHAPE PRESERVATION: All single events should have identical HRF integrals -->
        <check>
          <type>column_sum</type>
          <location>
            <column>3</column>  <!-- original -->
          </location>
          <expected>4.915</expected>
          <tolerance>0.01</tolerance>
          <description>Shape preservation: Original event total response</description>
        </check>
        
        <check>
          <type>column_sum</type>
          <location>
            <column>4</column>  <!-- shifted -->
          </location>
          <expected>4.915</expected>
          <tolerance>0.01</tolerance>
          <description>Shape preservation: Shifted event total response</description>
        </check>
        
        <check>
          <type>column_sum</type>
          <location>
            <column>5</column>  <!-- single from superposition test -->
          </location>
          <expected>4.915</expected>
          <tolerance>0.01</tolerance>
          <description>Shape preservation: Single event from superposition test</description>
        </check>
        
        <!-- 4. CAUSALITY: No response before stimulus onset -->
        <check>
          <type>exact_value</type>
          <location>
            <column>2</column>  <!-- impulse condition -->
            <row>4</row>  <!-- Before t=10s onset (t=8s) -->
          </location>
          <expected>0.0</expected>
          <tolerance>1e-10</tolerance>
          <description>Causality: No response before stimulus onset</description>
        </check>
        
        <!-- 5. ZERO DECAY: Response should decay to near-zero after sufficient time -->
        <check>
          <type>exact_value</type>
          <location>
            <column>2</column>  <!-- impulse condition -->
            <row>25</row>  <!-- ~20s after onset (t=50s) -->
          </location>
          <expected>0.0</expected>
          <tolerance>0.01</tolerance>
          <description>Response decay: Near-zero response 20s after onset</description>
        </check>
        
        <!-- 6. UNDERSHOOT BEHAVIOR: Check canonical HRF undershoot -->
        <check>
          <type>min</type>
          <location>
            <column>2</column>  <!-- impulse condition -->
          </location>
          <expected>-0.0102</expected>
          <tolerance>0.001</tolerance>
          <description>Canonical HRF undershoot magnitude</description>
        </check>
        
        <!-- 7. SUPERPOSITION PROPERTY: Overlapping events should sum linearly -->
        <!-- We cannot directly test this without matrix arithmetic, but we can verify individual responses -->
        <check>
          <type>peak_value</type>
          <location>
            <column>0</column>  <!-- double_first at t=82s -->
            <row_range>41,43</row_range>  <!-- Peak ~5-6s after t=82s -->
          </location>
          <expected>1.754</expected>
          <tolerance>0.01</tolerance>
          <description>Superposition: First overlapping event peak magnitude</description>
        </check>
        
        <check>
          <type>peak_value</type>
          <location>
            <column>1</column>  <!-- double_second at t=84s -->
            <row_range>42,44</row_range>  <!-- Peak ~5-6s after t=84s -->
          </location>
          <expected>1.754</expected>
          <tolerance>0.01</tolerance>
          <description>Superposition: Second overlapping event peak magnitude</description>
        </check>
        
        <!-- 8. PEAK TIMING CONSISTENCY: All events should peak at the same relative time -->
        <check>
          <type>exact_value</type>
          <location>
            <column>5</column>  <!-- single event at t=80s -->
            <row>42</row>  <!-- Expected peak time: t=80s + 6s = 86s = row 43 (0-indexed 42) -->
          </location>
          <expected>1.754</expected>
          <tolerance>0.01</tolerance>
          <description>Peak timing consistency: Single event peaks at expected time</description>
        </check>
      </numeric_checks>
    </design_matrix>
  </expected_outputs>
  
  <implementations>
    <R><![CDATA[
library(fmridesign)
library(fmrihrf)

# Create sampling frame
sframe <- sampling_frame(blocklens = 120, TR = 2.0)

# Create comprehensive event data for all test cases
event_data <- data.frame(
  onset = c(10.0, 40.0, 50.0, 80.0, 82.0, 84.0),
  condition = factor(c("impulse", "original", "shifted", "single", "double_first", "double_second")),
  block = rep(1, 6)
)

# Create event model with canonical HRF
ev_model <- event_model(
  onset ~ hrf(condition),
  data = event_data,
  block = ~block,
  sampling_frame = sframe,
  precision = 0.1
)

# Get design matrix
dm <- design_matrix(ev_model)

# Convert to regular matrix for numeric checks
dm_matrix <- as.matrix(dm)
    ]]></R>
  </implementations>
</golden_test>